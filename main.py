import json
from fastapi import FastAPI, UploadFile, File, Form
import numpy as np
from enum import Enum
from fastapi.middleware.cors import CORSMiddleware
from databases import Database
import pandas as pd
from scipy import sparse
from sklearn.preprocessing import normalize

app = FastAPI()


database = Database("sqlite:///moscow_recsys_db.db")


events_dict = {
        1: 'Автомобильная школа',
        2: 'Автомобильная школа',
        3: 'Авторская кукла. Продвинутый курс',
        4: 'Авторские курсы/маршруты',
        5: 'Адаптивная и тонизирующая Гимнастика',
        6: 'Адаптивная и тонизирующая Гимнастика',
        7: 'Акварельная живопись',
        8: 'Акварельная живопись',
        9: 'Акварельная живопись',
        10: 'Английский язык',
        11: 'Английский язык',
        12: 'Английский язык',
        13: 'Английский язык для начинающих',
        14: 'Английский язык для начинающих',
        15: 'Английский язык для общения и путешествий. Базовый курс',
        16: 'Английский язык для общения и путешествий. Базовый курс',
        17: 'Английский язык для общения и путешествий. Продвинутый курс',
        18: 'Английский язык для общения и путешествий.Продвинутый курс',
        19: 'Английский язык разговорный',
        20: 'Английский язык разговорный',
        21: 'Арабский язык',
        22: 'Арабский язык',
        23: 'Астрономия',
        24: 'Астрономия',
        25: 'Аэробика',
        26: 'Бадминтон',
        27: 'Бальные танцы',
        28: 'Бальные танцы',
        29: 'Бардовская песня',
        30: 'Баскетбол',
        31: 'Безопасность жизнедеятельности',
        32: 'Бильярд',
        33: 'Бисероплетение',
        34: 'Бодибалет',
        35: 'Большой теннис',
        36: 'Бояться нельзя или Смартфон для повседневной жизни',
        37: 'Бояться нельзя или Смартфон для повседневной жизни',
        38: 'Валяние из шерсти',
        39: 'Валяние из шерсти',
        40: 'Викторины',
        41: 'Витражное искусство',
        42: 'Волейбол',
        43: 'Волейбол(пионербол)',
        44: 'Восточные танцы',
        45: 'Восточные танцы',
        46: 'Вторая жизнь вещей',
        47: 'Вторая жизнь вещей',
        48: 'Вышивка атласными лентами',
        49: 'Вышивка гладью и крестом',
        50: 'Вышивка гладью и крестом',
        51: 'Вязание крючком',
        52: 'Вязание крючком',
        53: 'Вязание на спицах',
        54: 'Вязание на спицах',
        55: 'Генеалогия',
        56: 'Генеалогия',
        57: 'География',
        58: 'География. Путешествия вокруг света',
        59: 'Гимнастика',
        60: 'Гимнастика',
        61: 'Гимнастика мозга',
        62: 'Гимнастика мозга',
        63: 'ГимнастикаD-моделирование',
        64: 'Городки',
        65: 'Графика',
        66: 'Графика',
        67: 'ГТО',
        68: 'Дартс',
        69: 'Декупаж',
        70: 'Дизайн интерьера',
        71: 'Дизайн интерьера',
        72: 'Доступный интернет',
        73: 'Доступный интернет',
        74: 'Дыхательная Гимнастика',
        75: 'Дыхательная Гимнастика',
        76: 'Дыхательная Гимнастика по системе Стрельниковой',
        77: 'Дыхательная Гимнастика по системе Стрельниковой',
        78: 'Живопись с нуля(правополушарное рисование)',
        79: 'Защита от мошенников',
        80: 'Здоровая спина',
        81: 'Здоровая спина',
        82: 'Здорово жить',
        83: 'Здорово жить',
        84: 'Здоровое похудение',
        85: 'Здоровый образ жизни(ЗОЖ)',
        86: 'Здоровый образ жизни(ЗОЖ)',
        87: 'Здоровый сон',
        88: 'Зумба',
        89: 'Изготовление аксессуаров и декоративных украшений',
        90: 'Изготовление аксессуаров и декоративных украшений',
        91: 'Изготовление и оформление фотоальбомов Скрапбукинг',
        92: 'Изготовление кукол и игрушек',
        93: 'Изготовление кукол/игрушек',
        94: 'ИЗО',
        95: 'ИЗО',
        96: 'Иное литературное творчество',
        97: 'Иное литературное творчество',
        98: 'Информационное пространство жизни. Вводный курс',
        99: 'Информационные технологии для москвичей',
        100: 'Информационные технологии для москвичей',
        101: 'Иные иностранные языки',
        102: 'Иные иностранные языки',
        103: 'Иные интеллектуальные игры',
        104: 'Иные интеллектуальные игры',
        105: 'Иные настольные игры',
        106: 'Иные настольные игры',
        107: 'Иные подвижные игры',
        108: 'Иппотерапия',
        109: 'Искусство коммуникаций',
        110: 'Искусство коммуникаций',
        111: 'Испанский язык',
        112: 'Испанский язык',
        113: 'Испанский язык для общения и путешествий. Базовый курс',
        114: 'Испанский язык для общения и путешествий.Базовый курс',
        115: 'Исторические танцы',
        116: 'История зарубежного искусства',
        117: 'История и культура Москвы',
        118: 'История и культура России',
        119: 'История искусства',
        120: 'История искусства',
        121: 'История кинематографа',
        122: 'История литературы',
        123: 'История моды и прически',
        124: 'История моды и прически',
        125: 'История Москвы и России для всех поколений',
        126: 'История Москвы и России для всех поколений',
        127: 'История русского искусства',
        128: 'История. культура Москвы',
        129: 'История. культура России',
        130: 'Итальянский язык',
        131: 'Итальянский язык',
        132: 'Итальянский язык',
        133: 'Итальянский язык для общения и путешествий. Базовый курс',
        134: 'Йога',
        135: 'Йога',
        136: 'Как провести интересную экскурсию или организовать тур?',
        137: 'Как провести интересную экскурсию или организовать тур?',
        138: 'Калланетика',
        139: 'Канзаши японские традиционные женские украшения из атласных лент',
        140: 'Караоке',
        141: 'Каратэ',
        142: 'Карвинг искусство художественной резки по овощам и фруктам',
        143: 'Керамика (глина и тестоплатика)',
        144: 'Киберспорт',
        145: 'Киберспорт',
        146: 'Кинолекторий',
        147: 'Китайская живопись У-Син',
        148: 'Китайская живопись У-Син',
        149: 'Китайский язык',
        150: 'Китайский язык',
        151: 'Классические танцы',
        152: 'Клубные танцы',
        153: 'Корригирующая Гимнастика для глаз',
        154: 'Краеведение и онлайн-экскурсии',
        155: 'Краеведение и онлайн-экскурсии по Москве и России',
        156: 'Краеведение и пешие прогулки',
        157: 'Кулинарные курсы',
        158: 'Кулинарные курсы',
        159: 'Курсы компьютерной грамотности',
        160: 'Курсы компьютерной грамотности',
        161: 'Ландшафтный дизайн',
        162: 'Ландшафтный дизайн',
        163: 'Латиноамериканские танцы',
        164: 'Латиноамериканские танцы',
        165: 'Лечебная физкультура',
        166: 'Лечебная физкультура',
        167: 'Литература',
        168: 'Литература',
        169: 'Литературная мастерская',
        170: 'Литературная мастерская',
        171: 'Литературное творчество в современном мире. Базовый курс',
        172: 'Лоскутное шитье',
        173: 'Лыжи',
        174: 'Макраме',
        175: 'Масляная живопись',
        176: 'Масляная живопись',
        177: 'Мастеркласс по уходу за кожей в зрелом возрасте',
        178: 'Мастеркласс по уходу за кожей в зрелом возрасте',
        179: 'Ментальная арифметика',
        180: 'Ментальная арифметика',
        181: 'Младшая медсестра',
        182: 'Москвоведение',
        183: 'Москвоведение',
        184: 'Московский театрал',
        185: 'Московский театрал',
        186: 'Музыка',
        187: 'Народные танцы',
        188: 'Настольный теннис',
        189: 'Немецкий язык',
        190: 'Немецкий язык',
        191: 'Немецкий язык для общения и путешествий. Базовый курс',
        192: 'Немецкий язык для общения и путешествий.Базовый курс',
        193: 'Обучение игре на гитаре',
        194: 'Обучение игре на гитаре',
        195: 'Обучение игре на музыкальных инструментах',
        196: 'Обучение игре на фортепьяно',
        197: 'Огород на подоконнике',
        198: 'Огород на подоконнике',
        199: 'Оздоровительная Гимнастика',
        200: 'Оздоровительная Гимнастика',
        201: 'Оказание первой помощи',
        202: 'Осваиваем мобильные устройства',
        203: 'Осваиваем мобильные устройства',
        204: 'Основы академического рисунка и живописи',
        205: 'Основы академического рисунка и живописи',
        206: 'Основы духовной культуры',
        207: 'Основы духовной культуры',
        208: 'ОФП',
        209: 'ОФП',
        210: 'Памятники культуры',
        211: 'Памятники мирового искусства. Базовый курс',
        212: 'Памятники отечественного искусства',
        213: 'Папьемаше',
        214: 'Пение',
        215: 'Пение',
        216: 'Перезагрузка (программа школы для помощи внукам)/знай учебник лучше внука',
        217: 'Перезагрузка(программа школы для помощи внукам)/знай учебник лучше внука',
        218: 'Петанк(бочче)',
        219: 'Пилатес',
        220: 'Пилотное мастерство',
        221: 'Плетение из бумаги.квиллинг.оригами',
        222: 'Подарки своими руками',
        223: 'Подарки своими руками',
        224: 'Поэтические вечера',
        225: 'Правильное питание',
        226: 'Правильное питание',
        227: 'Правовая грамотность',
        228: 'Правовая грамотность',
        229: 'Предпринимательская деятельность в малом и среднем бизнесе',
        230: 'Прикладная живопись',
        231: 'Прикладная живопись',
        232: 'Продвинутый интернет',
        233: 'Продвинутый интернет',
        234: 'Психологические тренинги',
        235: 'Психологические тренинги',
        236: 'Психологические тренинги',
        237: 'Психологический лекторий',
        238: 'Психологический лекторий ',
        239: 'Психологический лекторий ',
        240: 'Путешествия вокруг света',
        241: 'Работа на компьютере и в социальных сетях',
        242: 'Различные техники рисования',
        243: 'Различные техники рисования',
        244: 'Регби',
        245: 'Рисование антистресс',
        246: 'Рисование анти-стресс',
        247: 'Рисуем песком',
        248: 'Ритмика и движение',
        249: 'Роспись по дереву. Художественная обработка древесины',
        250: 'Роспись по шелку (батик)',
        251: 'Роспись по шелку батик',
        252: 'Рукоделие и творчество',
        253: 'Рукоделие и творчество',
        254: 'Русское лото',
        255: 'Садоводство',
        256: 'Садоводство',
        257: 'Свой бизнес самозанятость',
        258: 'Свой бизнес. Самозанятость',
        259: 'Секреты немецкой грамматики. Продвинутый курс',
        260: 'Скалолазание',
        261: 'Скандинавская ходьба',
        262: 'Скорочтение',
        263: 'Скорочтение',
        264: 'Смартфоны и компьютеры - это удобно и практично',
        265: 'Современная песня',
        266: 'Современные настольные игры',
        267: 'Современные танцы',
        268: 'Современные танцы',
        269: 'Спортивные танцы',
        270: 'Спортивные танцы',
        271: 'Степаэробика',
        272: 'Стрейчинг',
        273: 'Суставная Гимнастика',
        274: 'Суставная Гимнастика',
        275: 'Тайцзи',
        276: 'Тайцзи',
        277: 'Танцевальная Гимнастика',
        278: 'Танцевальная Гимнастика',
        279: 'Танцевальная физкультура',
        280: 'Танцевальные вечера',
        281: 'Танцы для всех',
        282: 'Танцы для всех',
        283: 'Творческие встречи',
        284: 'Текстильный дизайн. Кройка и шитье',
        285: 'Текстильный дизайн. кройка и шитье',
        286: 'Техника речи',
        287: 'Тир. Стрельба из пневматическоголазерного оружия',
        288: 'Тренажер развития познавательных способностей',
        289: 'Тренажеры',
        290: 'Тренинги личностного роста',
        291: 'Тренировки долголетия(спецпроект по медицинской реабилитации)',
        292: 'Тунисское вязание',
        293: 'Турецкий язык',
        294: 'Турецкий язык',
        295: 'Тхэквондо',
        296: 'Уход за волосами',
        297: 'Уход и содержание домашних животных',
        298: 'Уход и содержание домашних животных',
        299: 'Ушу',
        300: 'Ушу',
        301: 'Фигурное катание',
        302: 'Физкультурно-оздоровительные занятия',
        303: 'Физкультурно-оздоровительные занятия',
        304: 'Фитнес',
        305: 'Фламенко',
        306: 'Флористика',
        307: 'Флористика',
        308: 'Фольклор',
        309: 'Фольклор',
        310: 'Фольклорная песня',
        311: 'Фотостудия/видеостудия',
        312: 'Фотостудия/видеостудия',
        313: 'Французский язык',
        314: 'Французский язык',
        315: 'Французский язык для общения и путешествий. Базовый курс',
        316: 'Французский язык для общения и путешествий.Базовый курс',
        317: 'Французский язык продвинутый курс',
        318: 'Футбол',
        319: 'Хореография',
        320: 'Хореография',
        321: 'Хоровое пение',
        322: 'Хоровое пение',
        323: 'Художественное слово',
        324: 'Художественные промыслы',
        325: 'Церковнославянский язык',
        326: 'Цигун',
        327: 'Цигун',
        328: 'Шахматы',
        329: 'Шахматы',
        330: 'Шахматы и шашки',
        331: 'Шахматы и шашки',
        332: 'Шашки',
        333: 'Школа макияжа',
        334: 'Школа макияжа',
        335: 'Школа маникюра',
        336: 'Школа моделей',
        337: 'Школа моделей',
        338: 'Экономическая и финансовая грамотность',
        339: 'Экономическая финансовая грамотность',
        340: 'Экопрактикум и экопривычки',
        341: 'Электронные услуги: учимся пользоваться',
        342: 'Эмоциональный интеллект',
        343: 'Эмоциональный интеллект',
        344: 'Японский язык',
        345: 'Японский язык'
    }


@app.on_event("startup")
async def database_connect():
    await database.connect()
    
    
@app.on_event("shutdown")
async def database_disconnect():
    await database.disconnect()
    
    
@app.post("/test/{user_id}/{rec_num}")
async def fetch_data(user_id: int, rec_num: int):
    
    query = "SELECT * FROM scrobbles"
    results = await database.fetch_all(query=query)
    
    user_id_list = [results[i]['user_id'] for i in range(len(results))]
    event_id_list = [results[i]['event_id'] for i in range(len(results))]
    scrobbles_list = [results[i]['scrobbles'] for i in range(len(results))]
    
    data = {'user_id': user_id_list, 'event_id': event_id_list, 'scrobbles': scrobbles_list}
    scrobbles_df = pd.DataFrame(data)
    
    rows, r_pos = np.unique(scrobbles_df.values[:, 0], return_inverse=True)
    cols, c_pos = np.unique(scrobbles_df.values[:, 1], return_inverse=True)
    
    scrobbles_sparse = sparse.csr_matrix((scrobbles_df.values[:, 2], (r_pos, c_pos)))
    
    Pui = normalize(scrobbles_sparse, norm='l2', axis=1)
    scrobbles_sparse_transposed = scrobbles_sparse.transpose(copy=True)
    Piu = normalize(scrobbles_sparse_transposed, norm='l2', axis=1)
    fit = Pui * Piu * Pui
    
    pred_set = set(list(events_dict)[i] for i in fit[user_id].toarray().argsort()[0][-rec_num:].tolist())
    
    return pred_set